metadata:
  name: consumer
  labels:
    nuclio.io/project-name: air-quality
spec:
  description: "Function the is called when a new message is arrived on the iot/sensors/co2 queue. the function send  back a feedback on the iot/logs queue."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  minReplicas: 1
  maxReplicas: 1
  triggers:
    MqttTrigger:
      class: ""
      kind: mqtt
      name: MqttTrigger
      url: "guest:guest@172.17.0.1:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/sensors/co2
    default-http:
      class: ""
      kind: http
      name: default-http
      maxWorkers: 1
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7DQp2YXIgbXF0dCA9IHJlcXVpcmUoJ21xdHQnKSwgdXJsID0gcmVxdWlyZSgndXJsJyk7DQogICAgdmFyIEZVTkNUSU9OX05BTUUgPSAiTU9OSVRPUiI7DQoNCiAgICB2YXIgbXF0dF91cmwgPSB1cmwucGFyc2UocHJvY2Vzcy5lbnYuQ0xPVURBTVFQX01RVFRfVVJMIHx8ICdtcXR0Oi8vZ3Vlc3Q6Z3Vlc3RAMTcyLjE3LjAuMToxODgzJyk7DQogICAgdmFyIGF1dGggPSAobXF0dF91cmwuYXV0aCB8fCAnOicpLnNwbGl0KCc6Jyk7DQogICAgdmFyIHVybCA9ICJtcXR0Oi8vIiArIG1xdHRfdXJsLmhvc3Q7DQoNCiAgICB2YXIgb3B0aW9ucyA9IHsNCiAgICBwb3J0OiBtcXR0X3VybC5wb3J0LA0KICAgIGNsaWVudElkOiAnbXF0dGpzXycgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDE2KS5zdWJzdHIoMiwgOCksDQogICAgdXNlcm5hbWU6IGF1dGhbMF0sDQogICAgcGFzc3dvcmQ6IGF1dGhbMV0sDQogICAgfTsNCg0KICAgIA0KICAgIC8vc2VuZCB2YWx1ZXMgdG8gdGhlIG1vbml0b3INCiAgICBmdW5jdGlvbiBzZW5kX3RvX21vbml0b3IobXNnKXsNCiAgICAgICAgdmFyIHEgPSAnaW90L2dyYXBoJzsNCiAgICAgICAgYW1xcC5jb25uZWN0KCdhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAMTcyLjE3LjAuMTo1NjcyJykudGhlbihmdW5jdGlvbihjb25uKSB7DQogICAgICAgICAgICByZXR1cm4gY29ubi5jcmVhdGVDaGFubmVsKCkudGhlbihmdW5jdGlvbihjaCkgew0KICAgICAgICAgICAgICAgIHZhciBvayA9IGNoLmFzc2VydFF1ZXVlKHEsIHtkdXJhYmxlOiBmYWxzZX0pOw0KICAgICAgICAgICAgICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsNCiAgICAgICAgICAgICAgICBjaC5zZW5kVG9RdWV1ZShxLCBCdWZmZXIuZnJvbShtc2cpKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2guY2xvc2UoKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSkuZmluYWxseShmdW5jdGlvbigpIHsgDQogICAgICAgICAgICAgICAgY29ubi5jbG9zZSgpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pLmNhdGNoKGNvbnNvbGUud2Fybik7DQogICAgfQ0KDQogICAgLy9jb252ZXJ0IGZyb20gYmluYXJ5IHRvIHN0cmluZywgY2FuIGJlIHVzZWZ1bGwNCiAgICBmdW5jdGlvbiBiaW4yc3RyaW5nKGFycmF5KXsNCiAgICAgICAgdmFyIHJlc3VsdCA9ICIiOw0KICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpew0KICAgICAgICByZXN1bHQrPSAoU3RyaW5nLmZyb21DaGFyQ29kZShhcnJheVtpXSkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgLy9EbyBhY3Rpb24gYWJvdXQgdGhlIGNvMiB2YWx1ZQ0KICAgIGV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7DQogICAgICAgIHZhciBfZXZlbnQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7DQogICAgICAgIHZhciBfZGF0YSA9IHBhcnNlSW50KGJpbjJzdHJpbmcoX2V2ZW50LmJvZHkuZGF0YSkpOw0KDQogICAgICAgIGlmIChfZGF0YSA+PSAyMCkgew0KICAgICAgICAgICAgdmFyIGNsaWVudCA9IG1xdHQuY29ubmVjdCh1cmwsIG9wdGlvbnMpOw0KICAgICAgICAgICAgY2xpZW50Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgY2xpZW50LnB1Ymxpc2goJ2lvdC9hY3R1YXRvci9mYW5zaXN0ZW0nLCAiMiIsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICBjbGllbnQuZW5kKCk7IA0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKCdNUVRUIE1lc3NhZ2UgU2VudCB0byBmYW4gc3lzdGVtJyk7IA0KICAgICAgICAgICAgICAgIH0gKTsgICAgICAgICAgICAgICAgDQogICAgICAgICAgICB9KTsgICAgDQogICAgICAgICAgICBzZW5kX3RvX21vbml0b3IoX2RhdGEudG9TdHJpbmcoKSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoX2RhdGEgPiAxMCAmJiAgX2RhdGEgPCAyMCkgew0KICAgICAgICAgICAgdmFyIGNsaWVudCA9IG1xdHQuY29ubmVjdCh1cmwsIG9wdGlvbnMpOw0KICAgICAgICAgICAgY2xpZW50Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgY2xpZW50LnB1Ymxpc2goJ2lvdC9hY3R1YXRvci9mYW5zaXN0ZW0nLCAiMSIsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICBjbGllbnQuZW5kKCk7IA0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKCdNUVRUIE1lc3NhZ2UgU2VudCB0byBmYW4gc3lzdGVtJyk7IA0KICAgICAgICAgICAgICAgIH0gKTsgICAgICAgICAgICAgICAgDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIHNlbmRfdG9fbW9uaXRvcihfZGF0YS50b1N0cmluZygpKTsNCg0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKF9kYXRhIDw9IDEwKSB7DQogICAgICAgICAgICB2YXIgY2xpZW50ID0gbXF0dC5jb25uZWN0KHVybCwgb3B0aW9ucyk7DQogICAgICAgICAgICBjbGllbnQub24oJ2Nvbm5lY3QnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBjbGllbnQucHVibGlzaCgnaW90L2FjdHVhdG9yL2ZhbnNpc3RlbScsICIwIiwgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIGNsaWVudC5lbmQoKTsgDQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2soJ01RVFQgTWVzc2FnZSBTZW50IHRvIGZhbiBzeXN0ZW0nKTsgDQogICAgICAgICAgICAgICAgfSApOyAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIH0pOyAgDQogICAgICAgICAgICBzZW5kX3RvX21vbml0b3IoX2RhdGEudG9TdHJpbmcoKSk7DQogICAgICAgIH0NCiAgICB9Ow0K
    commands:
      - 'npm install amqplib'
      - 'npm install mqtt'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
    timestamp: 1624727707
  loggerSinks:
    - level: debug
  platform: {}
  securityContext: {}
  eventTimeout: ""
